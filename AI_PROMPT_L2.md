# STM32 智能车工程 AI 协作二层提示词（L2）

## 0. 定位与启用规则

- 本文件用于“模块化场景规则 + 参数建议”，按任务选择性启用。
- 仅在对应模块改动时启用；未涉及模块不要强行套用。
- L2 与现实硬件冲突时，以当前接线、原理图、数据手册为准。
- L2 与 L1 冲突时，以 L1 为准。

---

## 1. OLED 与菜单（`menu*` / `OLED*`）

- 屏幕基线：128x64，SSD1306，IIC。
- 坐标基线：
  - `OLED_ShowString()` 第2参数是页号（0-7，每页8像素）。
  - 图形函数使用像素坐标（0-63）。
- 位序与扫描方向：
  - 页内位序 `bit0` 为页内上方，`bit7` 为页内下方。
  - 核查扫描方向配置（如 `0xC0` / `0xC8`）与安装方向一致。
- 布局约束：16号字高度16像素（占2页），避免行重叠。
- 菜单策略：支持滚动显示；选中态明显；短按确认、长按返回。
- 主菜单可视项按字体和留白在 3-4 行间取舍，优先保证不重叠、可读性和操作一致性。
- 进度条建议采用“标签 + 边框 + 填充 + 中点标记”样式，便于快速判断方向与幅值。
- 调试顺序：先底层显存/绘图，再页面布局，再交互逻辑。

---

## 2. 舵机、PWM、PS2（`servo*` / `PWM*` / `ps2*`）

- 驱动分层：驱动层只做 PWM/GPIO；摇杆映射、死区、滤波放控制层。
- 舵机经验参数（默认建议，不是硬约束）：
  - 50Hz（20ms），脉宽 1000-2000us，中点 1500us。
  - 摇杆映射：`pulse = 1500 + (stick - 128) * 500 / 127`。
  - 可调参数：死区、步进、滤波系数。
- 死区策略：死区外区间应重新映射到完整输出范围，避免“截断后行程损失”。
- 分层执行建议：`SetTarget` 放控制层，实际 PWM 输出放定时中断（如 TIM1 100us 回调）保证平滑性。
- 再初始化安全策略：若外设可能被改写，在本模块 `Init` 中重设 TIM 关键参数并触发更新事件。
- PS2 读取流程：先初始化，再周期扫描，保持数据结构统一输出。
- 接线与按键映射以当前工程头文件宏定义为准，不在业务代码硬编码。
- 历史接线样例（仅参考）：`CLK-PC3, CS-PC2, CMD-PC1, DAT-PC0`。

---

## 3. 遥控器事件与输入接口（`rf_*` / `key*` / `menu_input*`）

- 事件模型建议：单击、长按、长按松开三类事件。
- 长按阈值建议从 1000ms 起步，实测后参数化。
- 引脚映射建议集中在 `.h` 并结构化管理，便于换板和扩展。
- 接口设计偏好：优先“少而稳”的 API，避免拆成多步低层接口让上层拼装。

---

## 4. 软件 I2C 与陀螺仪（`soft_iic*` / `icm*` / `gyro*`）

- I2C 电气基线：
  - GPIO 使用开漏输出（`GPIO_MODE_OUTPUT_OD`）。
  - 外接上拉电阻（常见 4.7K 量级）。
- 地址与模式：
  - 7位地址在发送时需拼接读写位（左移1位）。
  - ICM42670 使用 I2C 时，CS 电平配置必须符合手册要求。
- 调试方法：GPIO翻转 -> START/STOP -> ACK/NACK -> 寄存器读写。
- 性能经验：软件 I2C 在密集寄存器访问下会明显占时，速度敏感路径优先评估硬件 I2C。
- 芯片识别：`WHO_AM_I` 必查，按实物型号命名并选择寄存器表。
- 兼容策略：可做多型号自动探测，但对外接口保持统一。
- 实现约束：优先 HAL 标准函数，不依赖位带地址技巧。

---

## 5. VL53L0X 与测距链路（`TOF*` / `VL53L0X*`）

- 延时策略：以数据手册为准，避免拍脑袋大延时。
- 起始经验值（仅用于首轮调通）：XSHUT 复位约 100us，boot 等待约 1.2ms。
- 轮询策略：状态轮询替代固定长延时，并强制超时退出。
- 返回值规范：初始化/读数函数统一返回成功或错误码。
- 调试策略：关键阶段保留可开关日志，便于定位初始化失败点。
- 性能评估：软件 I2C 速度不足时，优先评估切换硬件 I2C。

---

## 6. 电机驱动与 CAN（`motor*` / `can*`）

- 电机驱动按芯片真值表实现，方向控制与 PWM 责任清晰分离。
- 多驱动并存时保持统一 API，切换实现不改上层调用。
- 速度区间建议显式定义并统一（示例：`-1000..1000`）。
- CAN 建议：
  - 明确消息 ID、数据帧字段和校验策略。
  - 有状态回传和超时/重发策略，避免“只下发不闭环”。
  - 自动控制场景关注端到端时延预算（毫秒级目标需实测验证）。

---

## 7. 菜单重构与代码组织

- 菜单显示逻辑集中在 `menu.c`，输入处理放在 `menu_input.c`。
- 辅助函数使用 `static` 并在文件顶部声明，减少链接和声明问题。
- 菜单改动优先限定在菜单相关文件，避免扩散影响驱动层。
- 新增函数命名避免冲突，必要时加模块前缀。

---

## 8. 参数建议表（全部可调，不要硬写死）

- `long_press_ms`：1000（长按阈值起点）。
- `servo_deadzone_deg`：2.0（舵机死区起点）。
- `servo_step_deg`：0.5（舵机平滑步进起点）。
- `gyro_lpf_alpha`：0.1（一阶低通起点）。
- `motor_speed_limit`：1000（速度幅值上限示例）。
- 所有参数建议以宏或配置项集中管理，并给出注释。

---

## 9. 模块任务输出补充项

当启用 L2 时，最终汇报在 L1 模板之外额外补两项：

- 本次启用的 L2 模块与关键参数。
- 参数来源（数据手册 / 实测 / 经验默认值）和后续调参建议。

---

## 10. 板级已知注意项（按需核查）

- STM32F4 的 PB4 常见为 JTAG 复用，若作普通 GPIO 需确认调试口复用配置。
- ICM 系列以实测 `WHO_AM_I` 判型，常见值示例：ICM42670 `0x67`、ICM42688 `0x42`（以手册和实物为准）。
- I2C 读写地址拼接与 CS 电平策略需和芯片手册一致，不允许凭经验硬写。
