# Tea_Lib - STM32 单片机框架

原本是面向智能车竞赛开发的分层架构的代码框架，移植到了**STM32 HAL库**
很适合新产品的快速开发
让开发者更专注于任务逻辑，而非底层驱动，方便移植和通信。

## 系统特点

### 分层架构

```
┌─────────────────────────────────────┐
│           1_Task 任务层             │  ← main函数、不同任务入口（如：主任务、调试）
├─────────────────────────────────────┤
│         2_Control 算法层            │  ← PID算法、菜单系统、运动控制
├─────────────────────────────────────┤
│          3_Driver 驱动层            │  ← 各类模块驱动、传感器驱动、电机驱动
└─────────────────────────────────────┘
```

**为什么选择分层？**
- 任务层不关心硬件细节，调用控制层接口即可
- 控制层算法与驱动解耦，方便移植
- 驱动层统一接口，更换传感器只需修改驱动文件

### 时基设计

系统基于定时器中断驱动，定时器只给周期标志位，实现类似FreeRTOS的非阻塞式任务调度，关键任务在固定1ms周期执行：

```
TIM1 (100us中断)
    └── TIM1_100us_Callback()
            ├── 1ms: EC11编码器扫描
            └── 用户扩展: 舵机控制、传感器读取等
```

**好处**：编码器消抖、按键检测、PID计算等时序敏感任务不受主循环影响。

同时高优先级任务也可以使用其他中断。
### 菜单系统

内置OLED菜单系统，支持：
- EC11旋转编码器导航
- 多页面切换（陀螺仪、电机、传感器测试等）
- FreeRTOS适配

**开发调试利器**：无需串口即可查看传感器数据、测试电机、调试参数。

## 运行流程

```
main()
  │
  ├── HAL_Init() / SystemClock_Config()    // CubeMX生成
  │
  ├── App_Init()                           // 业务初始化
  │       ├── Motor_Init()                 // 电机
  │       ├── OLED_Init()                  // 显示屏
  │       ├── Ec11_knob_Init()             // 编码器
  │       ├── HAL_TIM_Base_Start_IT()      // 启动时基定时器
  │       └── Menu_Init()                  // 菜单系统
  │
  └── App_Loop()                           // 主循环
          └── Menu_Run()                   // 菜单运行（处理输入+显示）
```

**中断流程**：
```
TIM1中断(100us)
    └── TIM1_100us_Callback()
            └── Ec11_knob_TIM_Callback()   // 编码器扫描(1ms周期)
```

## 适配的外设

| 外设 | 型号/类型 | 接口 | 说明 |
|------|-----------|------|------|
| **电机驱动** | TB6612FNG | PWM | 每个电机1路PWM，2路方向脚 |
| **电机驱动** | L298N | PWM | 每个电机2路PWM |
| **编码器** | 增量式编码器 | TIM(硬件) | 用于电机测速 |
| **舵机** | 标准舵机 | PWM | 0-180°角度控制 |
| **显示屏** | 0.96" OLED (SSD1306) | 软件I2C | 128×64分辨率 |
| **按键** | EC11旋转按钮 | GPIO | 带编码器滚动，用于菜单 |
| **陀螺仪** | ICM-42670-P | 软件I2C | 六轴IMU，支持±16g/±2000dps |
| **陀螺仪** | 维特GY-52 | 串口 | 串口通信的陀螺仪总成 |
| **测距** | VL53L0X TOF模块 | 软件I2C | 激光测距，最大2m |
| **遥控** | PS2无线手柄 | GPIO | 支持振动反馈 |
| **遥控** | 蜂鸟R1A M5N | GPIO | 4键无线遥控按键 |

## 快速开始

### 最小系统初始化

```c
#include "app_main.h"
#include "menu.h"

int main(void) {
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    
    App_Init();    // 初始化业务模块
    App_Loop();    // 进入主循环
}

// 定时器中断回调（在stm32f4xx_it.c中调用）
void TIM1_100us_Callback(void) {
    Ec11_knob_TIM_Callback();  // 编码器扫描
}
```

### 添加自定义任务

```c
void App_Loop(void) {
    while(1) {
        Menu_Run();       // 菜单系统
        
        // 或运行自定义任务
        // Car_Task_Main(); // 小车控制任务
    }
}
```

## 目录结构

```
hsc_Lib/
├── 1_Task/                    # 任务层
│   ├── hsc.*                  # 核心定义（类型、位带、延时、多串口printf）
│   ├── app_main.*             # 应用主入口
│   └── car_task.*             # 小车控制任务示例
│
├── 2_Control/                 # 控制层
│   ├── hsc_pid.*              # PID算法（位置式/增量式）
│   ├── menu.*                 # OLED菜单系统
│   ├── hsc_math.*             # 数学工具（距离、角度、滤波）
│   └── imu_collision.*        # IMU碰撞检测
│
└── 3_Driver/                  # 驱动层
    ├── OLED/                  # OLED驱动 + u8g2图形库
    ├── VL53L0X/               # VL53L0X激光测距
    ├── icm42670.*             # ICM-42670陀螺仪
    ├── soft_iic.*             # 软件I2C（可配置引脚）
    ├── motor_standard.*       # 标准电机驱动
    ├── motor_tb6612.*         # TB6612电机驱动
    ├── encoder.*              # 硬件编码器
    ├── encoder_knob.*         # EC11旋转编码器
    ├── ps2.*                  # PS2手柄
    ├── remote_key.*           # 无线遥控器
    └── servo.*                # 舵机驱动
```

## 适用场景

- 智能车竞赛
- 麦轮/全向轮机器人
- 平衡小车
- 循迹/避障小车
- 嵌入式教学项目

## 依赖

- STM32F1/F4 HAL库
- Keil MDK / STM32CubeIDE
- C99标准
- GB2312中文编码

## 移植指南

1. 复制 `Tea_Lib` 到项目
2. 添加源文件到工程
3. 包含头文件路径
4. 修改 `common.h` 中的引脚定义
5. 在定时器中断中调用 `Ec11_knob_TIM_Callback()`

## 版本

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2026-02 | 初始版本 |

### git 提交前缀
| 前缀   | 核心含义                | 适用场景                                                                 | 示例                          |
|--------|-------------------------|--------------------------------------------------------------------------|-------------------------------|
| add    | 新增/添加               | 新增文件、新增功能、新增代码块、新增依赖等                             | [add] 新增oled画线函数         |
| del    | 删除/移除               | 删除无用代码、删除废弃文件、移除冗余依赖等                             | [del] 删除oled旧版初始化代码   |
| bug    | 修复bug                 | 任何功能逻辑错误、异常、兼容性问题的修复                              | [bug] 修复oled画线坐标偏移     |
| modify | 修改/调整               | 功能逻辑调整、参数修改、样式优化（非重构/非新增/非修复）                 | [modify] 调整oled画线粗细参数  |
| update | 更新/升级               | 依赖更新、配置更新、文档更新、版本升级（比modify更侧重“版本/内容更新”）   | [update] 更新oled驱动版本到v2  |
| revert | 回滚                    | 撤销之前的提交（恢复到某版代码）                                     | [revert] 回滚add oled画线函数  |

## 许可证

MIT License
